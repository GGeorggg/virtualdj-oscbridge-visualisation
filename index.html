<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VDJ Fullscreen Pro Bridge</title>
    <script src="https://cdn.jsdelivr.net/npm/osc-js@2.1.0/lib/osc.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: #fff; }

        /* DEBUG OVERLAY (Top Center) */
        #debug-console {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            width: 500px; height: 120px; background: rgba(0,0,0,0.8);
            border: 1px solid #333; border-radius: 8px; font-family: monospace;
            font-size: 10px; padding: 10px; overflow-y: hidden; pointer-events: none;
            z-index: 100; color: #00ff88; white-space: pre;
        }

        .ui-overlay { position: fixed; inset: 0; z-index: 10; pointer-events: none; }

        /* DECK CONTAINERS */
        .deck-ctrl { 
            position: absolute; bottom: 30px; width: 340px; height: 180px;
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid #222; border-radius: 20px;
            overflow: hidden; pointer-events: auto;
            transition: width 0.8s cubic-bezier(0.19, 1, 0.22, 1), 
                        height 0.8s cubic-bezier(0.19, 1, 0.22, 1), 
                        bottom 0.8s cubic-bezier(0.19, 1, 0.22, 1),
                        left 0.8s cubic-bezier(0.19, 1, 0.22, 1),
                        right 0.8s cubic-bezier(0.19, 1, 0.22, 1),
                        border-radius 0.5s;
        }

        #deck-1 { left: 30px; z-index: 11; }
        #deck-1.on-air { width: 100vw; height: 100vh; left: 0; bottom: 0; border-radius: 0; border: none; z-index: 25; }

        #deck-2 { right: 30px; z-index: 11; }
        #deck-2.on-air { width: 100vw; height: 100vh; right: 0; bottom: 0; border-radius: 0; border: none; z-index: 26; }

        /* VIDEO ENGINE */
        .v-engine { position: absolute; inset: 0; z-index: 0; opacity: 0; transition: opacity 0.5s; }
        .has-vid .v-engine { opacity: 0.5; }
        .on-air .v-engine { opacity: 1; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* UI CONTENT */
        .content {
            position: absolute; inset: 0; z-index: 1; padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 80%);
            transition: padding 0.8s;
        }
        .on-air .content { padding: 60px; }
        .on-air#deck-2 .content { align-items: flex-end; text-align: right; }

        /* METERS */
        .status-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 800; font-family: monospace; border: 1px solid #444; color: #00ff88; background: #000; }
        .track-name { font-size: 1.2rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; margin-bottom: 5px;}
        .vol-rail { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 10px 0; }
        .vol-bar { height: 100%; width: 0%; background: #00ff88; }
        .on-air .vol-bar { background: #ff3e3e; }
        .time-display { font-family: monospace; font-size: 1.1rem; margin-bottom: 5px; color: #fff; }
        .prog-rail { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; width: 100%; }
        .prog-bar { height: 100%; width: 0%; background: #fff; }
        #deck-2.on-air .prog-bar { float: right; }
    </style>
</head>
<body>

    <div id="debug-console">Initializing OSC...</div>

    <div class="ui-overlay">
        <div class="deck-ctrl" id="deck-1">
            <div class="v-engine"><video id="vid-1" muted loop playsinline></video></div>
            <div class="content">
                <div class="status-row">
                    <span style="color: #888; font-size: 11px; font-weight: 900;">DECK 1</span>
                    <span id="pitch-1" class="badge">0.00%</span>
                </div>
                <div>
                    <div class="track-name" id="name-1">---</div>
                    <div class="vol-rail"><div id="vol-1" class="vol-bar"></div></div>
                    <div class="time-display"><span id="elapsed-1">00:00.000</span></div>
                    <div class="prog-rail"><div id="prog-1" class="prog-bar"></div></div>
                </div>
            </div>
        </div>

        <div class="deck-ctrl" id="deck-2">
            <div class="v-engine"><video id="vid-2" muted loop playsinline></video></div>
            <div class="content">
                <div class="status-row">
                    <span style="color: #888; font-size: 11px; font-weight: 900;">DECK 2</span>
                    <span id="pitch-2" class="badge">0.00%</span>
                </div>
                <div>
                    <div class="track-name" id="name-2">---</div>
                    <div class="vol-rail"><div id="vol-2" class="vol-bar"></div></div>
                    <div class="time-display"><span id="elapsed-2">00:00.000</span></div>
                    <div class="prog-rail"><div id="prog-2" class="prog-bar"></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = new WebSocket('ws://localhost:9122');
        socket.binaryType = 'arraybuffer';
        const debugEl = document.getElementById('debug-console');
        const vdjData = {
            1: { play: false, audible: false, file: "", vol: 0, pos: 0, pitch: 0, range: 0.12, time: 0 },
            2: { play: false, audible: false, file: "", vol: 0, pos: 0, pitch: 0, range: 0.12, time: 0 }
        };

        function logDebug(msg) {
            const lines = debugEl.innerText.split('\n');
            lines.push(msg);
            if (lines.length > 8) lines.shift();
            debugEl.innerText = lines.join('\n');
        }

        socket.onopen = () => {
            logDebug("CONNECTED TO VDJ");
            [1, 2].forEach(d => {
                ["get_filename", "get_position", "is_audible", "play", "volume", "pitch", "pitch_range", "get_time"].forEach(p => {
                    sendOSC(`/vdj/subscribe/deck/${d}/${p}`);
                    p === "get_time" ? sendOSC(`/vdj/query/deck/${d}/${p}`, "elapsed") : sendOSC(`/vdj/query/deck/${d}/${p}`);
                });
            });
            requestAnimationFrame(renderLoop);
        };

        function sendOSC(address, arg = null) {
            const encoder = new TextEncoder();
            const addrBytes = encoder.encode(address);
            const addrPad = Math.ceil((addrBytes.length + 1) / 4) * 4;
            let buf;
            if (arg) {
                const argBytes = encoder.encode(arg);
                const argPad = Math.ceil((argBytes.length + 1) / 4) * 4;
                buf = new Uint8Array(addrPad + 4 + argPad);
                buf.set(addrBytes);
                buf.set(encoder.encode(",s"), addrPad);
                buf.set(argBytes, addrPad + 4);
            } else {
                buf = new Uint8Array(addrPad + 4);
                buf.set(addrBytes);
                buf.set([44, 0, 0, 0], addrPad);
            }
            socket.send(buf);
        }

        socket.onmessage = (event) => {
            const raw = new Uint8Array(event.data);
            const ascii = new TextDecoder().decode(raw).replace(/[^\x20-\x7E]/g, '.');

            if (ascii.includes("#bundle")) {
                [1, 2].forEach(d => {
                    ["play", "is_audible", "get_time", "get_position", "pitch"].forEach(p => {
                        if (ascii.includes(`/vdj/deck/${d}/${p}`)) {
                            p === "get_time" ? sendOSC(`/vdj/query/deck/${d}/${p}`, "elapsed") : sendOSC(`/vdj/query/deck/${d}/${p}`);
                        }
                    });
                });
            }

            try {
                const msg = new OSC.Message();
                msg.unpack(new DataView(event.data));
                const addr = msg.address;
                const d = addr.match(/deck\/(\d+)/)?.[1];
                
                if (d) {
                    let val = msg.args[0];
                    const vid = document.getElementById(`vid-${d}`);

                    if (addr.includes("get_time")) {
                        const newTimeMs = parseInt(val);
                        if (Math.abs(vid.currentTime * 1000 - newTimeMs) > 200) vid.currentTime = newTimeMs / 1000;
                        vdjData[d].time = newTimeMs;
                    }
                    else if (addr.includes("pitch_range")) {
                        vdjData[d].range = parseFloat(val);
                        logDebug(`D${d} RANGE: ${val}`);
                    }
                    else if (addr.includes("pitch")) {
                        // FIXED PITCH LOGIC: 0 is center
                        const rawVal = parseFloat(val);
                        const pitchPct = rawVal * (vdjData[d].range * 100);
                        vdjData[d].pitch = pitchPct;
                        vid.playbackRate = Math.max(0.1, 1.0 + (pitchPct / 100));
                    }
                    else if (addr.includes("play")) {
                        vdjData[d].play = (raw[raw.length - 1] === 1);
                        vdjData[d].play ? vid.play().catch(()=>{}) : vid.pause();
                        sendOSC(`/vdj/query/deck/${d}/get_time`, "elapsed");
                    }
                    else if (addr.includes("get_position")) vdjData[d].pos = val * 100;
                    else if (addr.includes("volume")) vdjData[d].vol = val * 100;
                    else if (addr.includes("is_audible")) vdjData[d].audible = (raw[raw.length - 1] === 1);
                    else if (addr.includes("get_filename") && val) {
                        vdjData[d].file = String(val).replace(/\.[^/.]+$/, "");
                        logDebug(`D${d} LOAD: ${vdjData[d].file}`);
                        checkVideo(d, vdjData[d].file);
                    }
                }
            } catch (e) {}
        };

        function formatMS(ms) {
            const mins = Math.floor(ms / 60000);
            const secs = Math.floor((ms % 60000) / 1000);
            const mils = Math.floor(ms % 1000);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${mils.toString().padStart(3, '0')}`;
        }

        function renderLoop() {
            [1, 2].forEach(d => {
                const data = vdjData[d];
                const isOnAir = data.play && data.audible;
                
                document.getElementById(`vol-${d}`).style.width = `${data.vol}%`;
                document.getElementById(`prog-${d}`).style.width = `${data.pos}%`;
                document.getElementById(`pitch-${d}`).innerText = (data.pitch >= 0 ? "+" : "") + data.pitch.toFixed(2) + "%";
                document.getElementById(`name-${d}`).innerText = data.file || "---";
                document.getElementById(`elapsed-${d}`).innerText = formatMS(data.time);

                const ctrl = document.getElementById(`deck-${d}`);
                isOnAir ? ctrl.classList.add('on-air') : ctrl.classList.remove('on-air');
            });
            requestAnimationFrame(renderLoop);
        }

        async function checkVideo(dNum, filename) {
            const vid = document.getElementById(`vid-${dNum}`);
            const deck = document.getElementById(`deck-${dNum}`);
            const url = `videos/${encodeURIComponent(filename)}.mp4`;
            try {
                const res = await fetch(url, { method: 'HEAD' });
                if (res.ok) { 
                    vid.src = url; vid.load(); 
                    deck.classList.add('has-vid'); 
                } else { deck.classList.remove('has-vid'); }
            } catch (e) { deck.classList.remove('has-vid'); }
        }
    </script>
</body>
</html>
