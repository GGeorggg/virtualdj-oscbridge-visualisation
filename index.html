<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VDJ Monitor - Professional Bridge</title>
    <script src="https://cdn.jsdelivr.net/npm/osc-js@2.1.0/lib/osc.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: #050505; 
            color: #e0e0e0; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
        }

        /* Debugger & Controls */
        .controls { 
            background: #1a1a1a; 
            padding: 12px 25px; 
            border-radius: 10px; 
            border: 1px solid #333; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            font-size: 0.8rem; 
        }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #333; transition: .4s; border-radius: 20px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; 
            background-color: white; transition: .4s; border-radius: 50%; 
        }
        input:checked + .slider { background-color: #00ff88; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Deck UI */
        .decks-container { display: flex; gap: 30px; }
        .deck { 
            background: #111; 
            border-radius: 20px; 
            padding: 30px; 
            width: 340px; 
            border: 4px solid #222; 
            opacity: 0.5; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .deck.on-air { 
            border-color: #ff3e3e; 
            opacity: 1; 
            box-shadow: 0 0 30px rgba(255, 62, 62, 0.2);
            transform: scale(1.02);
        }
        .deck-header {
            color: #555;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .on-air .deck-header { color: #ff3e3e; }

        .filename { 
            font-size: 1.2rem; 
            font-weight: 600; 
            height: 2.8em; 
            margin: 15px 0; 
            color: #fff; 
            overflow: hidden; 
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .progress-container { background: #222; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: #00ff88; transition: width 0.1s linear; }
        .on-air .progress-bar { background: #ff3e3e; }
        
        #last-msg { color: #666; font-family: monospace; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div class="controls">
        <span>Debug Console</span>
        <label class="switch">
            <input type="checkbox" id="debug-toggle" checked>
            <span class="slider"></span>
        </label>
        <span id="last-msg">Waiting for WebSocket...</span>
    </div>

    <div class="decks-container">
        <div class="deck" id="deck-1">
            <div class="deck-header">Deck 1</div>
            <div class="filename" id="d1-file">Waiting for track...</div>
            <div class="progress-container"><div id="d1-progress" class="progress-bar"></div></div>
        </div>

        <div class="deck" id="deck-2">
            <div class="deck-header">Deck 2</div>
            <div class="filename" id="d2-file">Waiting for track...</div>
            <div class="progress-container"><div id="d2-progress" class="progress-bar"></div></div>
        </div>
    </div>

    <script>
        const socket = new WebSocket('ws://localhost:9122');
        socket.binaryType = 'arraybuffer';
        const osc = new OSC();
        
        const debugToggle = document.getElementById('debug-toggle');
        const states = { 1: { playing: false, audible: false }, 2: { playing: false, audible: false } };

        // Hex formatting helper
        const toHex = (buf) => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(' ');

        // Spec-compliant OSC Message Sender
        function sendOSC(address) {
            const encoder = new TextEncoder();
            const addrBytes = encoder.encode(address);
            const addrPad = Math.ceil((addrBytes.length + 1) / 4) * 4;
            const buf = new Uint8Array(addrPad + 4);
            buf.set(addrBytes);
            buf.set([44, 0, 0, 0], addrPad); // Type tag string "," null-padded
            
            socket.send(buf);
            if (debugToggle.checked) console.log(`>>> OUT: ${address}`);
        }

        socket.onopen = () => {
            document.getElementById('last-msg').innerText = "Connected";
            const paths = ["get_filename", "get_position", "is_audible", "play"];
            [1, 2].forEach(d => paths.forEach(p => {
                sendOSC(`/vdj/subscribe/deck/${d}/${p}`);
                sendOSC(`/vdj/query/deck/${d}/${p}`);
            }));
        };

        socket.onmessage = (event) => {
            let buffer = event.data;
            const rawUint8 = new Uint8Array(buffer);
            const hex = toHex(buffer);
            
            // Critical: Ensure multiple of 4 for library stability
            if (buffer.byteLength % 4 !== 0) {
                const padded = new Uint8Array(Math.ceil(buffer.byteLength / 4) * 4);
                padded.set(rawUint8);
                buffer = padded.buffer;
            }

            if (rawUint8[0] === 0x23) { // Bundle starting with '#'
                processBundle(buffer, hex);
            } else {
                processMessage(buffer, hex, rawUint8);
            }
        };

        function processBundle(buffer, hex) {
            try {
                const bundle = new OSC.Bundle();
                bundle.unpack(new DataView(buffer));
                if (debugToggle.checked) console.log(`<<< BUNDLE (${bundle.elements.length} items)`);
                bundle.elements.forEach(m => {
                    // Note: Bundles don't get the raw bit-check fix here; 
                    // if VDJ bundles broken booleans, we handle via handleUI normalization
                    handleUI(m.address, m.args[0]);
                });
            } catch (e) {
                // Fallback: If bundle is malformed, re-query paths found in string
                const str = new TextDecoder().decode(buffer);
                const matches = str.match(/\/vdj\/deck\/\d\/[a-z_]+/g);
                if (matches) matches.forEach(m => sendOSC(m.replace('/vdj/', '/vdj/query/')));
            }
        }

        function processMessage(buffer, hex, rawUint8) {
            try {
                const msg = new OSC.Message();
                msg.unpack(new DataView(buffer));
                
                let val = msg.args[0];

                // VDJ FIX: Manual trailing-bit check for booleans hidden in empty string tags
                const isBoolPath = msg.address.endsWith('/play') || msg.address.includes('is_audible');
                if (isBoolPath && (val === "" || val === undefined)) {
                    val = rawUint8[rawUint8.length - 1] === 1;
                }

                if (debugToggle.checked) {
                    console.log(`<<< MSG: ${msg.address} | VAL: ${val} | HEX: ${hex}`);
                }
                
                handleUI(msg.address, val);
            } catch (e) {
                if (debugToggle.checked) console.error("Unpack error", e);
            }
        }

        function handleUI(addr, val) {
            const m = addr.match(/deck\/(\d+)/);
            if (!m) return;
            const dNum = m[1];
            
            // Normalize values for UI logic
            const isActive = (val === 1 || val === "1" || val === true);

            if (addr.includes("is_audible")) {
                states[dNum].audible = isActive;
            } else if (addr.endsWith("/play")) {
                states[dNum].playing = isActive;
            } else if (addr.includes("get_position")) {
                const pos = parseFloat(val);
                if (!isNaN(pos)) document.getElementById(`d${dNum}-progress`).style.width = (pos * 100) + "%";
            } else if (addr.includes("filename")) {
                const name = String(val).split(/[\\/]/).pop().replace(/\.[^/.]+$/, "") || "Empty";
                document.getElementById(`d${dNum}-file`).innerText = name;
            }

            // Sync On-Air Status
            const deckEl = document.getElementById(`deck-${dNum}`);
            if (states[dNum].playing && states[dNum].audible) {
                deckEl.classList.add('on-air');
            } else {
                deckEl.classList.remove('on-air');
            }
            
            document.getElementById('last-msg').innerText = addr;
        }
    </script>
</body>
</html>
